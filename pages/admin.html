<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Usuarios</title>
    <script>
        (function () {
            try {
                var savedMode = localStorage.getItem('darkMode');
                var useDark = savedMode === '1' || savedMode === 'true';
                if (savedMode === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    useDark = true;
                }
                document.documentElement.classList.toggle('dark-mode', !!useDark);
            } catch (_) {}
        })();
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322c55e' width='100' height='100' rx='20'/><text y='70' font-size='60' fill='white' text-anchor='middle' x='50' font-weight='bold'>$</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../assets/css/app.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="../assets/js/core/password-utils.js"></script>
    <script src="../assets/js/core/loading-utils.js"></script>
    <script src="../assets/js/core/firebase-utils.js"></script>
    <script src="../assets/js/core/theme-utils.js"></script>
    <script src="../assets/js/core/session-utils.js"></script>
    <script src="../assets/js/core/toast-utils.js"></script>
    <script src="../assets/js/core/status-utils.js"></script>
    <script src="../assets/js/core/list-utils.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, child, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteUser, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB3spppto5IEYRAxFOe0jdBGAnMvJRn8K8",
            authDomain: "facturacionelectronica-c2155.firebaseapp.com",
            databaseURL: "https://facturacionelectronica-c2155-default-rtdb.firebaseio.com",
            projectId: "facturacionelectronica-c2155",
            storageBucket: "facturacionelectronica-c2155.firebasestorage.app",
            messagingSenderId: "1071386903920",
            appId: "1:1071386903920:web:c58b1a0148d3856b5a3bb5",
            measurementId: "G-13S9Z6SMB4"
        };
        
        const app = initializeApp(firebaseConfig);
        const userProvisionApp = initializeApp(firebaseConfig, 'userProvisionApp');
        const database = getDatabase(app);
        const auth = getAuth(app);
        const userProvisionAuth = getAuth(userProvisionApp);
        
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseChild = child;
        window.firebaseOnValue = onValue;
        window.firebaseAuthStateChanged = onAuthStateChanged;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseDeleteUser = deleteUser;
        window.firebaseProvisionAuth = userProvisionAuth;
    </script>
    
    <!-- Styles moved to ../assets/css/app.css -->
</head>
<body class="page-admin bg-white text-gray-900 min-h-screen flex flex-col">
    <div id="appLoading" class="app-loading-overlay">
        <div class="app-loading-card">
            <div class="app-spinner"></div>
            <div class="app-loading-text">Cargando...</div>
        </div>
    </div>
    <!-- Navbar similar to index.html -->
    <nav class="admin-nav border-b border-gray-200 px-6 py-4 flex justify-between items-center bg-white sticky top-0 z-50">
        <div class="flex items-center gap-6">
            <span class="nav-title text-lg font-semibold">Facturación Electrónica - Admin</span>
            <button onclick="window.location.href='../index.html'" class="px-3 py-2 rounded-md text-sm font-medium transition-colors back-invoices-btn">
                Volver a Facturas
            </button>
        </div>
        <div class="flex items-center gap-6">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Alternar modo oscuro" aria-label="Alternar modo oscuro">
                <div class="toggle-icon">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </div>
            </button>
            <span id="currentUserEmail" class="text-sm"></span>
            <button onclick="logout()" class="text-sm flex items-center gap-2 transition-colors nav-link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Logout
            </button>
        </div>
    </nav>
    <main class="flex-1 max-w-6xl w-full mx-auto px-6 py-8">
        <div class="admin-panel-card bg-white rounded-xl border border-gray-200 shadow-sm p-6">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4 mb-7">
                <div>
                    <h1 class="admin-panel-title text-2xl font-bold">Panel de Administración</h1>
                    <p class="admin-panel-subtitle text-sm text-gray-500">Gestiona usuarios, exporta/importa y revisa acciones del administrador.</p>
                </div>
                <div class="w-full lg:w-auto flex flex-col sm:flex-row sm:items-stretch gap-3">
                    <div class="admin-search-bar w-full sm:min-w-[320px] flex items-center border rounded-full overflow-hidden">
                        <input id="userSearch" type="text" placeholder="Buscar por email" class="admin-search-input flex-1 px-3 h-10 text-sm" />
                        <select id="pageSize" class="admin-page-size px-3 h-10 text-sm border-l">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    <button id="exportBtn" class="h-10 px-3 rounded text-sm soft-btn whitespace-nowrap">Exportar JSON</button>
                    <input id="importFile" type="file" accept="application/json" class="hidden" />
                    <button id="importBtn" class="h-10 px-3 rounded text-sm soft-btn whitespace-nowrap">Importar JSON</button>
                </div>
            </div>

            <form id="userForm" class="grid grid-cols-12 gap-3 items-end mb-7">
                <div class="col-span-12 md:col-span-4">
                    <label class="admin-form-label block text-xs font-semibold mb-1">Email</label>
                    <input id="uemail" type="email" class="w-full px-3 py-2 border rounded" required />
                </div>
                <div class="col-span-12 md:col-span-4 relative">
                    <label class="admin-form-label block text-xs font-semibold mb-1">Contraseña</label>
                    <div class="admin-password-wrap">
                        <input id="upass" type="password" class="admin-password-input w-full px-3 py-2 border rounded" required />
                        <button type="button" class="admin-password-toggle" onclick="togglePasswordVisibility('upass')" title="Mostrar/ocultar contraseña">
                            <svg id="upass-eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                    </div>
                </div>
                <div class="col-span-12 sm:col-span-6 md:col-span-2">
                    <label class="admin-form-label block text-xs font-semibold mb-1">Rol</label>
                    <select id="urole" class="w-full h-10 px-3 border rounded">
                        <option value="user">Usuario</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="col-span-12 sm:col-span-6 md:col-span-2">
                    <button type="submit" class="w-full h-10 px-4 bg-green-600 text-white rounded whitespace-nowrap">Crear usuario</button>
                </div>
            </form>

            <h2 class="admin-section-title text-lg font-semibold mt-4 mb-2">Usuarios existentes</h2>
            <div class="admin-table-wrapper overflow-x-auto bg-white rounded border">
                <table class="min-w-full text-sm users-table">
                    <thead>
                        <tr>
                            <th class="col-index p-3 text-center">#</th>
                            <th class="p-3 text-left">Email</th>
                            <th class="p-3 text-center">Rol</th>
                            <th class="p-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody"></tbody>
                </table>
            </div>

            <div class="flex justify-between items-center mt-4">
                <div class="flex items-center gap-2">
                    <button id="prevPage" class="h-10 px-4 rounded soft-btn">Anterior</button>
                    <button id="nextPage" class="h-10 px-4 rounded soft-btn">Siguiente</button>
                </div>
                <div class="admin-page-meta text-sm text-gray-600">Página <span id="currentPage">1</span></div>
            </div>
        </div>
    </main>

    <script src="../assets/js/admin/config.js"></script>
    <script src="../assets/js/admin/data.js"></script>
    <script src="../assets/js/admin/auth.js"></script>
    <script src="../assets/js/admin/ui.js"></script>
    <script src="../assets/js/anti-inspection.js"></script>
</body>
</html>
