<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturación</title>
    <script>
        (function () {
            try {
                var savedMode = localStorage.getItem('darkMode');
                var useDark = savedMode === '1' || savedMode === 'true';
                if (savedMode === null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    useDark = true;
                }
                document.documentElement.classList.toggle('dark-mode', !!useDark);
            } catch (_) {}
        })();
    </script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2322c55e' width='100' height='100' rx='20'/><text y='70' font-size='60' fill='white' text-anchor='middle' x='50' font-weight='bold'>$</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/app.css">
        <style>
        @media print {
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                box-sizing: border-box;
            }
            .btn-imprimir, .btn-cerrar, .boton, button {
                display: none !important;
            }
            .factura-container {
                display: flex;
                flex-wrap: wrap;
                align-items: flex-start;
                justify-content: center;
                width: 100vw;
                height: auto;
                gap: 0;
                page-break-inside: avoid;
            }
            .factura {
                margin: 0 !important;
                page-break-inside: avoid;
                width: auto !important;
                max-width: 100% !important;
                box-sizing: border-box;
            }
            /* Elimina espacio extra */
            html, body {
                width: 100vw;
                height: auto;
                overflow: visible !important;
            }
        }
        </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.2/lib/anime.min.js"></script>
    <script src="assets/js/core/password-utils.js"></script>
    <script src="assets/js/core/loading-utils.js"></script>
    <script src="assets/js/core/firebase-utils.js"></script>
    <script src="assets/js/core/theme-utils.js"></script>
    <script src="assets/js/core/session-utils.js"></script>
    <script src="assets/js/core/toast-utils.js"></script>
    <script src="assets/js/core/status-utils.js"></script>
    <script src="assets/js/core/list-utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, child, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB3spppto5IEYRAxFOe0jdBGAnMvJRn8K8",
            authDomain: "facturacionelectronica-c2155.firebaseapp.com",
            databaseURL: "https://facturacionelectronica-c2155-default-rtdb.firebaseio.com",
            projectId: "facturacionelectronica-c2155",
            storageBucket: "facturacionelectronica-c2155.firebasestorage.app",
            messagingSenderId: "1071386903920",
            appId: "1:1071386903920:web:c58b1a0148d3856b5a3bb5",
            measurementId: "G-13S9Z6SMB4"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        window.firebaseDB = database;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseGet = get;
        window.firebaseSet = set;
        window.firebaseChild = child;
        window.firebaseOnValue = onValue;
        window.firebaseAuthStateChanged = onAuthStateChanged;
    </script>
    
    <!-- Styles moved to assets/css/app.css -->
</head>
<body class="page-index bg-white text-gray-900 min-h-screen flex flex-col">
    <div id="appLoading" class="app-loading-overlay">
        <div class="app-loading-card">
            <div class="app-spinner"></div>
            <div class="app-loading-text">Cargando...</div>
        </div>
    </div>

    

    <!-- Navbar -->
    <nav class="app-nav border-b border-gray-200 px-6 py-4 flex justify-between items-center bg-white sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <span class="nav-title text-lg font-semibold">Facturación Electrónica</span>
            <button id="btnNewInvoice" onclick="showInvoiceForm()" class="bg-gray-800 hover:bg-gray-800 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 transition-colors">            
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Nueva Factura
            </button>
            <a id="btnHistoryView" href="pages/historial.html" class="bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"></path><circle cx="12" cy="12" r="10"></circle></svg>
                <span>Historial pagadas</span>
            </a>
            <button id="btnBackupExport" type="button" class="backup-nav-btn bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                <span>Exportar</span>
            </button>
            <button id="btnBackupImport" type="button" class="backup-nav-btn bg-white hover:bg-gray-50 text-gray-800 border border-gray-200 px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <span>Importar</span>
            </button>
            <input id="backupImportInput" type="file" accept="application/json" class="hidden">
            <div id="adminPanelBtnContainer"></div>
        </div>
        <div class="flex items-center gap-6">
            <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Alternar modo oscuro" aria-label="Alternar modo oscuro">
                <div class="toggle-icon">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </div>
            </button>
            <span id="currentUserEmail" class="text-sm"></span>
            <button onclick="logout()" class="text-sm flex items-center gap-2 transition-colors nav-link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Salir
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 max-w-6xl w-full mx-auto px-6 py-8 w-full">
        
        <!-- Lista de Facturas (Vista Principal) -->
        <div id="invoiceListView">
            <div class="flex justify-between items-center mb-6">
                <h1 id="invoiceListTitle" class="text-2xl font-bold uppercase tracking-wide text-gray-900">Facturas Activas</h1>
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-500" id="totalCount">0 total</span>
                </div>
            </div>

            <div id="operationalAlerts" class="operational-alerts hidden mb-4">
                <div class="op-alert-chip op-alert-overdue">Vencidas: <strong id="alertOverdueCount">0</strong></div>
                <div class="op-alert-chip op-alert-today">Vencen hoy: <strong id="alertTodayCount">0</strong></div>
                <div class="op-alert-chip op-alert-soon">Próx. 3 días: <strong id="alertSoonCount">0</strong></div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <div class="flex-1 relative">
                    <input type="text" id="searchInput" placeholder="Buscar facturas..." class="w-full h-10 px-4 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-gray-900 transition-colors">
                </div>
                <select id="filterSelect" class="h-10 pl-4 pr-10 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-gray-900 bg-white min-w-[180px] cursor-pointer">
                    <option value="all">Todas las activas</option>
                    <option value="dispatch">Despacho</option>
                    <option value="abono">Abono</option>
                    <option value="saldo_actual">Saldo Actual</option>
                    <option value="paid">Pagada</option>
                    <option value="pending">Pendiente</option>
                    <option value="late">Vencida</option>
                </select>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="flex flex-col items-center justify-center py-20 text-center">
                <p class="text-gray-500 mb-6 text-base">Aún no hay facturas. Crea una factura para comenzar</p>
            </div>

            <!-- Invoice List Container - Grid de Cards -->
            <div id="invoiceList" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>

            <!-- Paginación -->
            <div id="paginationContainer" class="hidden mt-8 flex justify-center items-center gap-2">
                <button onclick="previousPage()" class="h-10 px-4 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    ← Anterior
                </button>
                <div id="pageButtons" class="flex gap-2"></div>
                <button onclick="nextPage()" class="h-10 px-4 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    Siguiente →
                </button>
            </div>
        </div>

        <!-- Formulario de Factura Provisional (Oculto por defecto) -->
        <div id="invoiceFormView" class="hidden max-w-3xl mx-auto">
            <div class="invoice-form-card bg-white border border-gray-200 rounded-xl p-8 shadow-sm">
                <h2 class="invoice-form-title invoiceFormTitle text-xl font-bold text-center uppercase tracking-wide mb-8 text-gray-900 border-b border-gray-100 pb-4">Crear Factura Provisional</h2>
                
                <form id="invoiceForm" class="invoiceForm" onsubmit="handleSubmit(event)">
                    <!-- Fecha y Número -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Día</label>
                            <input type="number" id="dia" min="1" max="31" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="19">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Mes</label>
                            <input type="number" id="mes" min="1" max="12" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="2">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Año</label>
                            <input type="number" id="anio" min="2020" max="2100" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="2026">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">N°</label>
                            <input type="number" id="numero" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="8420" readonly>
                        </div>
                    </div>

                    <!-- Cliente, Dirección, Estado -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Cliente</label>
                            <input type="text" id="cliente" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Dirección</label>
                            <input type="text" id="direccion" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors">
                        </div>
                        <div>
                            <label class="status-label block text-xs font-bold text-orange-500 uppercase mb-1.5 tracking-wider">Estado</label>
                            <select id="estado" class="status-select w-full px-3 py-2 border-2 rounded-md text-sm focus:outline-none bg-white cursor-pointer font-semibold">
                                <option value="dispatch">Despacho</option>
                                <option value="abono">Abono</option>
                                <option value="saldo_actual">Saldo Actual</option>
                                <option value="paid">Pagada</option>
                                <option value="pending">Pendiente</option>
                                <option value="late">Vencida</option>
                            </select>
                            <label class="mt-2 inline-flex items-center gap-2 text-xs text-gray-600">
                                <input type="checkbox" id="estadoManualLock" class="h-4 w-4 border border-gray-300 rounded">
                                <span>Mantener estado manual</span>
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Abono</label>
                            <input type="number" id="abono" min="0" step="0.01" value="0" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="0.00" oninput="calculateTotals()">
                        </div>
                        <div id="saldoActualWrapper" class="hidden">
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Saldo Actual</label>
                            <div class="invoice-saldo-box w-full px-3 py-2 rounded-md text-sm font-semibold">
                                <span class="invoice-saldo-currency">$</span> <span id="saldoActualAmount">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div id="statusExtras" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div id="dispatchWrapper" class="hidden sm:col-span-2">
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Detalle de Despacho</label>
                            <input type="text" id="detalleDespacho" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors" placeholder="Ej.: Entrega en bodega central">
                        </div>
                        <div id="dueDateWrapper">
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Fecha de vencimiento</label>
                            <input type="date" id="fechaVencimiento" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors">
                            <p class="date-format-hint mt-1 text-xs text-gray-400">Formato mostrado: dd-mm-aaaa</p>
                        </div>
                        <div id="paidDateWrapper" class="hidden">
                            <label class="block text-xs font-semibold text-gray-700 uppercase mb-1.5">Fecha de pago</label>
                            <input type="date" id="fechaPago" class="w-full px-3 py-2 border border-gray-200 rounded-md text-sm focus:outline-none focus:border-gray-900 transition-colors">
                            <p class="date-format-hint mt-1 text-xs text-gray-400">Formato mostrado: dd-mm-aaaa</p>
                        </div>
                    </div>

                    <!-- Tabla de Items -->
                    <div class="items-table-wrapper mb-6 border border-gray-200 rounded-lg overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="items-table-head bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 uppercase text-xs w-12">#</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 uppercase text-xs w-20">Cant.</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 uppercase text-xs">Descripción</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700 uppercase text-xs w-32">Precio</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700 uppercase text-xs w-32">Valor</th>
                                    <th class="w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                <tr class="border-b border-gray-100">
                                    <td class="py-2 px-2 text-center" data-label="#">
                                        <span class="item-index text-gray-700 font-semibold">1</span>
                                    </td>
                                    <td class="py-2 px-2" data-label="Cant.">
                                        <input type="number" min="0" step="0.01" value="1" class="item-cant w-full px-2 py-1.5 border border-gray-200 rounded text-center text-sm focus:outline-none focus:border-gray-900" oninput="calculateTotals()">
                                    </td>
                                    <td class="py-2 px-2" data-label="Descripcion">
                                        <textarea class="item-desc item-desc-area w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:border-gray-900" placeholder="Descripción del item" rows="2"></textarea>
                                    </td>
                                    <td class="py-2 px-2" data-label="Precio">
                                        <input type="number" min="0" step="0.01" class="item-precio w-full px-2 py-1.5 border border-gray-200 rounded text-sm focus:outline-none focus:border-gray-900" placeholder="0.00" oninput="calculateTotals()">
                                    </td>
                                    <td class="py-2 px-2 text-right" data-label="Valor">
                                        <span class="item-valor text-gray-900 font-medium">0</span>
                                    </td>
                                    <td class="py-2 px-2 text-center remove-cell" data-label="Eliminar">
                                        <button type="button" class="removeItemBtn" onclick="removeItem(this)">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                            <span class="remove-label">Eliminar item</span>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" id="addItemBtn" onclick="addItem()" class="add-item-btn w-full py-2 text-sm text-gray-500 hover:text-gray-900 hover:bg-gray-50 transition-colors border-t border-gray-200 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Agregar Item
                        </button>
                    </div>

                    <!-- Total -->
                    <div class="invoice-total-row flex justify-end mb-8 border-t border-gray-200 pt-4">
                        <div class="text-right">
                            <span class="invoice-total-label text-sm font-semibold text-gray-700 uppercase mr-2">Total</span>
                            <span class="invoice-total-amount text-lg font-bold text-gray-900">$ <span id="totalAmount">0.00</span></span>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="flex justify-end gap-3">
                        <button id="cancelBtn" type="button" onclick="cancelInvoice()" class="px-6 py-2.5 text-sm font-medium rounded-lg transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" id="submitBtn" class="px-6 py-2.5 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors">
                            Crear factura
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>
    <script src="assets/js/index/backup-and-shared-utils.js"></script>
    <script src="assets/js/index/invoices-store-and-draft.js"></script>
    <script src="assets/js/index/invoices-form-and-validation.js"></script>
    <script src="assets/js/index/access-control-auth.js"></script>
    <script src="assets/js/index/invoices-list-and-pagination.js"></script>
    <script src="assets/js/index/invoices-actions-and-events.js"></script>
    <script src="assets/js/anti-inspection.js"></script>
</body>
</html>
